# 整体分析

钱包子系统（Wallet-Service）职责一句话：  
“**负责所有币种的充值检测、提币广播、余额变动记账，以及注册发奖，本身不触碰私钥，只通过内网 RPC 集群调用链节点完成打币/地址生成。**”

下面按文件拆解职能、协作关系，并给出端到端业务流程图。

------------------------------------------------
一、6 个文件职能速查
------------------------------------------------
| 文件 | 主要功能 | 在项目中的角色 |
|---|---|---|
| 1. WalletApplication | Spring Boot 启动类 + @EnableDiscoveryClient 注册到 Eureka | 钱包微服务入口 |
| 2. TestController | 两条调试接口：① 查某币种链高度 ② 批量检查所有币种 RPC 是否存活 | 运维/测试探针 |
| 3. MemberConsumer | 监听 `member-register` 给新用户批量建空钱包；监听 `reset-member-address` 后台强制换地址 | 用户生命周期伴随钱包初始化 |
| 4. FinanceConsumer | 监听 `deposit` 处理链上充值；监听 `withdraw` 自动调用 RPC 打币；监听 `withdraw-notify` 处理打币结果回调 | **资金进出中枢** |
| 5. RestTemplateConfig | 带 @LoadBalanced 的 RestTemplate Bean | 通过服务名调用 RPC 集群 |
| 6. KafkaConfiguration | 仅 `@EnableKafka` 开启注解消费功能 | 启用 Kafka 监听器 |

------------------------------------------------
二、整体协作链路（文字版）
------------------------------------------------
1. 启动  
   WalletApplication 注册 Eureka → 其他服务可通过 `SERVICE-WALLET` 发现它。

2. 用户注册  
   会员服务发 Kafka `member-register` → MemberConsumer  
   → 为每种 Coin 新建 `MemberWallet`（余额 0，地址空）  
   → 若有“注册奖励”活动，直接给对应币种加余额并写流水。

3. 充值检测（链→业务）  
   每条公链的扫描程序（独立微服务）发现新区块包含平台地址 → 发 Kafka `deposit`（key=币种全称）  
   → FinanceConsumer  
   → 验重（txid）→ 调 `memberWalletService.recharge()` 上账 → 写余额 & 交易流水 → ES 索引方便后台查询。

4. 提币请求（业务→链）  
   用户在前端提交提币 → 财务服务审核通过后发 Kafka `withdraw`（key=币种 unit）  
   → FinanceConsumer  
   → 通过 RestTemplate 调用 `SERVICE-RPC-XXX/rpc/withdraw?address=&amount=&fee=`  
   → 返回 txid 即认为成功，更新订单状态＝已汇出；返回失败则转人工审核。

5. 提币结果回调  
   RPC 节点广播完交易后发 Kafka `withdraw-notify`  
   → FinanceConsumer  
   → status=1 更新为“已完成”；status=0 回滚为“等待放币”，可再次重试。

6. 地址更换  
   运营后台可发 Kafka `reset-member-address` 强制换地址 → MemberConsumer 直接改库。

------------------------------------------------
三、端到端业务流程图
------------------------------------------------
```
┌-----------┐    1.register     ┌-----------┐
│Member     │---Kafka topic----▶│Wallet     │ 创建空钱包
│Service    │   member-register │Service    │ 发奖余额
└-----------┘                   └-----┬-----┘
                                     │2.deposit
                                ┌----▼-----┐
                                │Chain     │扫描新区块
                                │Scanner   │
                                └----┬-----┘
                                     │3.Kafka deposit
                               ┌-----▼-----┐
                               │Finance    │验重→上账→ES
                               │Consumer   │
                               └-----┬-----┘
                                     │4.withdraw
                               ┌-----▼-----┐
                               │Finance    │调用RPC打币
                               │Consumer   │
                               └-----┬-----┘
                                     │5.withdraw-notify
                               ┌-----▼-----┐
                               │Finance    │更新状态
                               │Consumer   │
                               └-----------┘
         ┌----------------------------------------------┐
         ▼              RPC 集群（SERVICE-RPC-XXX）     ▼
   链节点返回 txid / 失败                链节点广播后回调
```

------------------------------------------------
四、一句话总结
------------------------------------------------
钱包服务本身**不碰私钥、不连节点**，完全通过 Kafka 接收**“链扫描器”**和**“财务审核”**的事件，再用 RestTemplate 调用内网 RPC 集群完成**地址生成、链上打币、区块高度查询**，从而实现**充值自动上账、提币自动广播、余额实时变动**的闭环。













